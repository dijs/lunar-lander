const data = `{"nh":100,"ns":8,"na":5,"net":{"W1":{"n":100,"d":8,"w":{"0":0.005739510012509571,"1":-0.019920062887736276,"2":0.01671029155167955,"3":0.02212068957563851,"4":-0.03964532097908281,"5":0.02859140574233045,"6":-0.03227107743136973,"7":-0.01995491151928792,"8":-0.006101815763482113,"9":0.020354683454721346,"10":0.08984633208510107,"11":0.08747311206533744,"12":-0.17082123083592382,"13":-0.026630291491363523,"14":-0.10332062505088888,"15":0.016205063576487756,"16":-0.014240831091318467,"17":-0.005661998504779781,"18":-0.020271984764790012,"19":-0.011103495531062732,"20":0.02257997952942877,"21":0.019581930739828862,"22":0.047586549615989966,"23":-0.020990248326534327,"24":-0.01703277002685442,"25":0.008664277515173693,"26":-0.04222249751065744,"27":-0.02169570271481762,"28":0.06425887503138311,"29":-0.004912251548873703,"30":0.040510928939750564,"31":0.0007111438779111646,"32":0.0032469276884634257,"33":-0.005627069736932763,"34":-0.07317739337280085,"35":-0.07057298473627947,"36":0.16228831892700643,"37":0.0064384909099421475,"38":0.08953119630005035,"39":-0.01664539356218315,"40":-0.016606088343038825,"41":0.008033879886178017,"42":0.0456232615721756,"43":0.05322943946603082,"44":-0.12472091312217981,"45":-0.0189356787227238,"46":-0.10318799632765215,"47":0.05552951650791432,"48":-0.005041306562442301,"49":0.029238096296974866,"50":-0.030630085634342604,"51":-0.04714740881816523,"52":0.08299632731179928,"53":-0.02914681570744381,"54":0.05167829975707603,"55":-0.002260651864323158,"56":-0.015017189700638625,"57":-0.04501976564784289,"58":-0.026418633084974025,"59":-0.03291014877529259,"60":0.09216575130688658,"61":0.02253421562654534,"62":0.07102257964168772,"63":-0.0418829146901434,"64":0.02102049121906003,"65":0.03598368084093847,"66":0.0684512930133134,"67":0.06873612370235585,"68":-0.15895017042439738,"69":-0.028695903860544738,"70":-0.08866770959033847,"71":0.04278160978107338,"72":-0.0035807405782419363,"73":-0.022338426649323548,"74":-0.0823322439267949,"75":-0.07458847785259395,"76":0.17748787261490712,"77":0.021485930780066213,"78":0.0908450755872575,"79":-0.025768854229811625,"80":-0.013256010425073331,"81":-0.00717069191418162,"82":0.05791011561920864,"83":0.08573792951785053,"84":-0.1733697996452883,"85":-0.011915367546957765,"86":-0.09335058683156902,"87":0.047002339717140455,"88":0.013692326666095812,"89":0.0000420106113666291,"90":0.04556548690461893,"91":0.011231922082621498,"92":-0.09157441580420296,"93":0.008626557360136126,"94":-0.06258846363157036,"95":-0.0023730937341238842,"96":-0.057200048358207856,"97":-0.027849232293249017,"98":-0.08952165048265072,"99":-0.08586800290396045,"100":0.14920583183856215,"101":0.005318519970468807,"102":0.08912215056841283,"103":0.004811025694949206,"104":-0.006720082001916088,"105":-0.03312018526911014,"106":0.0710323871102522,"107":0.07629658533633407,"108":-0.1741359941913834,"109":-0.04118506472573855,"110":-0.09824087295295458,"111":0.03471281455194125,"112":0.006910929117125278,"113":0.015957941271691412,"114":0.027689972312895907,"115":0.019660117764419567,"116":-0.10792591975385118,"117":0.004247478028581132,"118":-0.07527202466909541,"119":0.03201173683816091,"120":-0.011104111372583781,"121":0.022374350023712613,"122":0.0845782796754557,"123":0.06221392825586359,"124":-0.18690418828482816,"125":-0.03560850561784516,"126":-0.09068396228865654,"127":0.04168822332162831,"128":0.01817065488102412,"129":0.05482818856218209,"130":-0.09642934954388482,"131":-0.10559496131041743,"132":0.26530274377756297,"133":0.12173810719639769,"134":0.031355687708539526,"135":-0.008898561455739867,"136":0.011036488032029418,"137":0.005579655853451751,"138":-0.03792987820081268,"139":-0.052576765908594565,"140":0.11177078773520295,"141":-0.0037679131673376987,"142":0.0877262794322116,"143":-0.02560125373583186,"144":0.005318831276696556,"145":0.007116200659820655,"146":0.027709473665835538,"147":0.016289735550251618,"148":-0.02229088874049584,"149":-0.0017429450409623959,"150":-0.010652188248378058,"151":-0.01248185578855286,"152":0.007407365906288362,"153":0.011394891630606911,"154":0.06588116053494103,"155":0.07493215843045574,"156":-0.14108663093977722,"157":0.023963025796794643,"158":-0.08173386791655196,"159":-0.004130133673426313,"160":-0.001079178512055212,"161":-0.0004284595997241132,"162":-0.05898663322477727,"163":-0.045432252988415335,"164":0.13409895360343083,"165":0.008794138582935696,"166":0.09835049914972832,"167":-0.021057524211271963,"168":-0.007912921706144087,"169":0.008732166124396172,"170":-0.017795504441611387,"171":-0.035770338108014915,"172":0.05322861978157125,"173":-0.031486342637664165,"174":0.029854259044217134,"175":0.008487947644452253,"176":0.015693921540738155,"177":-0.015814821140923772,"178":0.055947406067500226,"179":0.08584076540080214,"180":-0.1275712352915284,"181":0.018605871509205892,"182":-0.06810656192374591,"183":-0.004150119167418034,"184":-0.028306601896780272,"185":-0.013305581315650742,"186":0.10201917413844583,"187":0.11594527110124321,"188":-0.2067183880690328,"189":-0.05656065177057679,"190":-0.08344723241714455,"191":0.025630955705232862,"192":0.007133350564531509,"193":0.007798963535808415,"194":0.06210549177600197,"195":0.059799543477396244,"196":-0.12882583503311976,"197":0.006124058554115276,"198":-0.09028454334851599,"199":0.01528450231469793,"200":0.024797153241282496,"201":-0.001641507416305045,"202":-0.07977338609130694,"203":-0.09112627090299558,"204":0.18461572941582566,"205":0.03912269153376137,"206":0.08621569728568447,"207":-0.043176712268927754,"208":-0.015770717350803955,"209":0.016651306072550304,"210":0.06288212175142037,"211":0.06427819331423723,"212":-0.15135468289771303,"213":-0.01907944607817469,"214":-0.11690142602863382,"215":0.06436100705132508,"216":0.0605927318373854,"217":0.07310325085916732,"218":0.0952890147912933,"219":0.10462953993394745,"220":-0.19260333818627287,"221":-0.018750062588258884,"222":-0.09584360433748829,"223":0.037428797774347905,"224":0.002992409736505016,"225":0.024782891540780966,"226":-0.0026240464594001743,"227":-0.0035942756190084097,"228":-0.0034606503864466837,"229":0.010380377929273977,"230":-0.005489407255962607,"231":0.0020066580457069436,"232":0.030289724694336755,"233":-0.030401871185549358,"234":0.02794230473216084,"235":0.020462587171171012,"236":-0.06097740375161622,"237":0.031585705357236114,"238":-0.03401493668078561,"239":-0.015612680824296263,"240":-0.011149320483872018,"241":0.0061456471415473925,"242":-0.009447508965031767,"243":-0.012994572790730758,"244":0.02555646406872057,"245":-0.031458277932363,"246":-0.007719666370302441,"247":0.022838262257727653,"248":0.009419536248625363,"249":0.09794859296379443,"250":0.08902081310134388,"251":0.1116359611288577,"252":-0.21477888248706464,"253":-0.04421217829456337,"254":-0.1030681793951479,"255":0.06369695311052247,"256":-0.0007499903510751918,"257":-0.027692381957808716,"258":-0.045417812237232395,"259":-0.0373565917799328,"260":0.08380901464510415,"261":0.008334133536155154,"262":0.06609127198493289,"263":-0.02683682744253134,"264":-0.04141021323670217,"265":0.01064469444056578,"266":-0.061896969929352466,"267":-0.043267974209424166,"268":0.1380870525063875,"269":-0.000785165870858319,"270":0.08018402809726358,"271":-0.025608783642964508,"272":-0.011531360304199254,"273":0.009940131999955264,"274":0.026010914026282504,"275":0.01918051137733582,"276":-0.062081858902035054,"277":-0.0010258325383514042,"278":-0.025820195419274876,"279":0.027181641256688475,"280":0.002793580073614052,"281":-0.024166172386731775,"282":-0.04267472464568824,"283":-0.052006655220779935,"284":0.12834042222821712,"285":0.020402799993159266,"286":0.10596044575165844,"287":-0.05302103826702625,"288":-0.0097731277692687,"289":0.027112186592572828,"290":0.0128308863891493,"291":-0.009382132332351344,"292":-0.012433687290919017,"293":-0.03835488200161301,"294":-0.04162205313229179,"295":0.046434196881564936,"296":0.016055746792095007,"297":-0.02040965836938413,"298":-0.014807648984350991,"299":-0.031960909347661826,"300":0.05432448467279897,"301":-0.008528396519637046,"302":0.058143181636961264,"303":-0.04009300020665284,"304":-0.007389229276965174,"305":0.013898734545779428,"306":0.08557939313991719,"307":0.09232376133807373,"308":-0.17107393913872693,"309":-0.027710856863783967,"310":-0.09246430281443765,"311":0.034834196897665884,"312":0.043670537403691374,"313":0.002045943136869332,"314":0.07369383445796394,"315":0.07855378222113449,"316":-0.13901967380568558,"317":0.025278838436290037,"318":-0.09139976288748865,"319":0.013667627370906103,"320":0.0028617519501988133,"321":-0.0060861079077821015,"322":-0.004128217176871685,"323":0.0023162064671232033,"324":-0.02930600739602595,"325":0.00902657216083638,"326":-0.005599822440626144,"327":-0.011437775330201232,"328":-0.0024156744976206864,"329":0.07265597852891369,"330":0.053828118052831886,"331":0.06445080187951925,"332":-0.11816857038743192,"333":-0.012825433814355186,"334":-0.07902263939974652,"335":0.038463212387340795,"336":0.027019474496022097,"337":-0.022637317891154654,"338":0.040489927613376886,"339":0.03858235088645097,"340":-0.09816850400205465,"341":0.02279678156441293,"342":-0.07145847250751054,"343":-0.0039883288870157015,"344":-0.044452477861440305,"345":-0.06967624570657659,"346":0.11227895201938044,"347":0.1078553630074713,"348":-0.21190628009860646,"349":-0.0019665444130125714,"350":-0.054708639586551276,"351":-0.014719928251538889,"352":0.02612860735742451,"353":0.014649659868311933,"354":0.05258889129295062,"355":0.05873463408939137,"356":-0.1255834902418398,"357":0.004850545116677528,"358":-0.08727715992230713,"359":0.018125499381716946,"360":-0.014554440050725011,"361":-0.006878557382052977,"362":-0.05518937992256629,"363":-0.05564444756923093,"364":0.1334484111289692,"365":-0.019891543608227803,"366":0.06112509008731705,"367":0.012193147127313012,"368":0.00905632658264362,"369":0.004897883367528284,"370":0.04431361487236147,"371":0.05848341104370986,"372":-0.1290773719683334,"373":0.01873258803578268,"374":-0.07707507260647412,"375":0.029065258561342285,"376":0.007995770571173658,"377":0.017071397216378483,"378":-0.03956584004736046,"379":-0.04708435249119171,"380":0.09433272893170147,"381":-0.010067727804339689,"382":0.060137900875072266,"383":0.004638064727087586,"384":-0.01783854165683762,"385":-0.03875006993793592,"386":-0.06712994141492547,"387":-0.06350984555640504,"388":0.12629323356773628,"389":0.025801454159343484,"390":0.08630044823745636,"391":-0.0340398669229129,"392":-0.008510798932577418,"393":-0.006826954615049831,"394":0.0888300668228357,"395":0.07187566835865303,"396":-0.18342506568764616,"397":-0.03513951809847196,"398":-0.08042026077820229,"399":0.016944515292506974,"400":0.007574555288828388,"401":0.03077352366219824,"402":0.05340676496607432,"403":0.04160572616787619,"404":-0.09921773945257668,"405":-0.0012535852503003674,"406":-0.10703060242350626,"407":0.03832749424900638,"408":0.008991182355529433,"409":0.01629778406731309,"410":0.023377792055689503,"411":0.035890549546544824,"412":-0.08555851354807037,"413":0.002443860243075754,"414":-0.06702892063277462,"415":0.0403899138829239,"416":-0.008148842747987507,"417":-0.0046428662201936,"418":-0.06798146602746044,"419":-0.05862822734815667,"420":0.12539264533465458,"421":-0.008012232375251995,"422":0.08925072352330968,"423":-0.013258953238001159,"424":0.010167214490349701,"425":0.0063587918531559234,"426":0.025966844538593676,"427":0.036620185138343024,"428":-0.07304114330893136,"429":0.019337954315006192,"430":-0.05550831337280292,"431":0.005946776473990948,"432":-0.025412451355782472,"433":0.019845260673408815,"434":-0.003441085517596832,"435":-0.003432705226495823,"436":-0.010641138603240383,"437":-0.00288185276374226,"438":-0.03066755702375821,"439":0.028411219901206562,"440":-0.004819972646490479,"441":0.005875526723931649,"442":-0.013529144429303119,"443":-0.002475079312992257,"444":0.045195749188679565,"445":0.0010499905082160185,"446":0.026098786980698153,"447":-0.016834329822556574,"448":0.015024640764251113,"449":0.02640389593318393,"450":0.04827033363541744,"451":0.06255972321622434,"452":-0.1506594822422423,"453":-0.012763617468189851,"454":-0.09999197010291012,"455":0.04215098332729803,"456":0.03164396123332492,"457":-0.0012010044857961924,"458":-0.01951010930458256,"459":-0.05188859567340606,"460":0.10076796339568266,"461":0.0025818916673295295,"462":0.08363336463284993,"463":-0.04502201274097077,"464":-0.014735953031380224,"465":0.030061942040946817,"466":0.004698883602203886,"467":0.002372629072830744,"468":-0.046217171436533644,"469":-0.014817441897677945,"470":-0.046370654873599794,"471":0.0480953477907195,"472":0.0055877521350214555,"473":0.06084783587098128,"474":0.14101146144811078,"475":0.15667956784780504,"476":-0.26953443652550063,"477":-0.027666629103757282,"478":-0.08627441930138725,"479":0.024991997023946864,"480":-0.00029776404815153615,"481":-0.005368080594449902,"482":0.05933046891516875,"483":0.06824322477099103,"484":-0.14821539897880037,"485":0.012105264260543048,"486":-0.07318735707116598,"487":0.002202553432330983,"488":-0.00865403596759898,"489":0.023552577210378612,"490":0.03903924132758633,"491":0.050348977771173614,"492":-0.1162085756627305,"493":-0.024140655714664647,"494":-0.1035019248020909,"495":0.053179494995797286,"496":0.024779192858301265,"497":-0.004446613576585923,"498":-0.10164595532115353,"499":-0.10674711416029263,"500":0.22340621760657264,"501":0.053465879394108566,"502":0.07329442192238407,"503":-0.017566722389755353,"504":0.004437226996557085,"505":-0.012268152071000502,"506":0.07223443868686695,"507":0.06075909657781886,"508":-0.14291796352094036,"509":0.01851985455678453,"510":-0.09163056671539394,"511":0.0072736772774789635,"512":0.00004008214292078436,"513":-0.005322343945006039,"514":-0.07751293074195441,"515":-0.07857618084679578,"516":0.1825591080921031,"517":0.022137109727038553,"518":0.07379826329057548,"519":-0.02859636970872621,"520":0.033349807497746325,"521":-0.000608366537682708,"522":0.02738606346564119,"523":0.012964303640727858,"524":-0.06439179930991774,"525":0.02613858479710507,"526":-0.03014048456769988,"527":-0.021551299717041585,"528":0.015832703166064797,"529":-0.00013829276905533435,"530":0.03286001773269271,"531":0.04801632470933964,"532":-0.08643862774337026,"533":-0.005316674274694613,"534":-0.09055482058148133,"535":0.031102276312374742,"536":-0.02332623299483217,"537":-0.0023695733693106275,"538":-0.0338800788447326,"539":-0.037324547254439185,"540":0.0903760659631123,"541":-0.02566056787006407,"542":0.06562010061481696,"543":0.010146474652523146,"544":0.0131811161768154,"545":0.009854215268011762,"546":0.0036915110951283815,"547":0.0018576733862400022,"548":-0.000251962137940951,"549":-0.01665550387235662,"550":0.003627487597435265,"551":0.0058399634161888925,"552":-0.03525165468612916,"553":-0.08405459164610501,"554":-0.12004014952014318,"555":-0.12596648646121666,"556":0.22612495611884229,"557":0.03535057060786067,"558":0.10440223814895444,"559":-0.056846216930188084,"560":0.007554989458884079,"561":0.05758981572535294,"562":0.09078415264024275,"563":0.08815173598827478,"564":-0.2235950420124392,"565":-0.04172207656493155,"566":-0.07015690763030605,"567":0.03913372652356713,"568":-0.020106009060203305,"569":-0.005493265087948315,"570":-0.11418036650245539,"571":-0.09037708259103135,"572":0.2327225253261239,"573":0.056074218772040656,"574":0.052818953067305024,"575":0.01144569325572996,"576":-0.04903499815415432,"577":0.06401145981968749,"578":0.01880347692643025,"579":0.02003061594551132,"580":-0.06594732368443679,"581":-0.03117100211762773,"582":-0.062488977343045336,"583":0.0592675700161506,"584":0.00971009872845993,"585":-0.03327003108932322,"586":-0.07342898058488861,"587":-0.08601688107835304,"588":0.16466881108056775,"589":0.020283480810108192,"590":0.0928255131799488,"591":-0.02400700538464665,"592":0.009000216271225901,"593":-0.025480456765592477,"594":-0.09238663122941597,"595":-0.08586175314922587,"596":0.23709086288174608,"597":0.044935576991750784,"598":0.048058097635032826,"599":-0.021509446460593072,"600":-0.013865827996350374,"601":0.015588625555549847,"602":0.033448002307244803,"603":0.06314359851376672,"604":-0.10243317205511088,"605":-0.019525911096546514,"606":-0.08139337996280442,"607":0.04766837688524762,"608":0.016852065480921708,"609":0.012729540063780107,"610":-0.06257016512139196,"611":-0.05667751804009382,"612":0.15938285103136224,"613":0.033933446936041015,"614":0.1163666759048629,"615":-0.058599180965576,"616":-0.026255297857171043,"617":0.012477098510528806,"618":-0.03253746268948502,"619":-0.02393187666807842,"620":0.0625459451102665,"621":-0.0035583279779960023,"622":0.043070046894297456,"623":0.009969660463177182,"624":-0.014505396679197358,"625":0.00021228982184103988,"626":-0.024122333567551432,"627":-0.0048595449156734255,"628":0.038365998562389717,"629":0.0017082893551044625,"630":0.00569752530835987,"631":-0.013074931511271322,"632":-0.01020968872547402,"633":0.028410162837191617,"634":0.1489655811318759,"635":0.14112035372187673,"636":-0.3251200316497798,"637":-0.13023536609242137,"638":-0.01705232030032271,"639":-0.01374059637870212,"640":0.032850078220558424,"641":-0.018807106851532404,"642":-0.05063234308776962,"643":-0.04839880781117039,"644":0.09127693075297252,"645":0.014393786882048072,"646":0.07235758971032312,"647":-0.021579269937588786,"648":0.995867795415432,"649":0.952432773803901,"650":-0.5216018883923199,"651":-0.5079187709431506,"652":-0.4564522513526177,"653":-1.2925281629345415,"654":-1.3132528845070435,"655":1.2758317224595852,"656":-0.035499150173963795,"657":0.015777564058619933,"658":-0.07050455473340726,"659":-0.049753393031127684,"660":0.12168395118658214,"661":-0.015057608992498478,"662":0.07329861985647498,"663":0.0030711110853503835,"664":0.01714092305901081,"665":-0.0026713404864785358,"666":0.009381597219538112,"667":0.003777152414207327,"668":-0.020988681376061767,"669":-0.01812662920176901,"670":-0.04015345582427198,"671":0.0625455629365739,"672":-0.14312957961324613,"673":-0.13845210709616165,"674":0.12846502188769462,"675":0.181292327147843,"676":-0.21393611881310112,"677":0.10355724612601655,"678":-0.062068719123070853,"679":-0.05163050483886445,"680":-0.04283426263273036,"681":0.016373880030108815,"682":-0.027244102662746884,"683":-0.027792020465230265,"684":0.057563065800288374,"685":-0.02155688790245447,"686":0.036726021822322125,"687":0.007602655528082821,"688":0.020139696843001403,"689":-0.013995861494580781,"690":0.012890352384775153,"691":0.016724251758675684,"692":-0.05977530723601737,"693":0.012816497350444938,"694":-0.028859562565278902,"695":0.004462037259048766,"696":0.0035332974741270015,"697":-0.01616458571618099,"698":-0.013543124523385438,"699":-0.006620964786286347,"700":0.05040683773150292,"701":0.016800334171126478,"702":0.043090733987815606,"703":-0.03377493214905205,"704":-0.002793248514141129,"705":-0.0012323707979932617,"706":0.022411206186439367,"707":0.019438728681569598,"708":-0.06715111769844154,"709":-0.0007503435307352825,"710":-0.03691561911344422,"711":-0.0004959922526277405,"712":-0.013884970399536829,"713":0.027772474220192776,"714":0.00005127347152835112,"715":0.015353768642660423,"716":0.014684270886940397,"717":-0.01775784352879916,"718":-0.01748096593899944,"719":0.01687780035014337,"720":-0.009018995077266806,"721":0.02086626555054318,"722":0.06027072511687292,"723":0.0710435171680648,"724":-0.11395596579061149,"725":0.00214663539290601,"726":-0.08893487434968451,"727":0.02315878703238649,"728":0.005306603876240787,"729":-0.008685164543919146,"730":-0.004022586648594318,"731":-0.01339384460927229,"732":0.01437388291673735,"733":0.016124803120549872,"734":0.02773072974182033,"735":-0.022403288583502143,"736":0.02516868246469247,"737":0.022355906540122556,"738":0.09091660767602444,"739":0.0656522502603134,"740":-0.14530940430970798,"741":-0.0007909400591111416,"742":-0.07568779689753204,"743":0.0012540090109884928,"744":0.009208306266494135,"745":-0.0004413017863140492,"746":0.007321152344702918,"747":0.03321005841266432,"748":-0.0565217230580085,"749":-0.011966326935621005,"750":-0.049057159796615186,"751":0.015399638895592021,"752":0.010515857404455282,"753":0.008258406399427955,"754":0.029713676022695604,"755":0.016894955888231446,"756":-0.09773437663851585,"757":-0.027528904975534764,"758":-0.09838353121265445,"759":0.06988222664141985,"760":0.006741127131988746,"761":0.008492080342154434,"762":0.007627369320773541,"763":0.006336769814522457,"764":0.002806392635351805,"765":0.01457464021321552,"766":-0.015053932094509635,"767":-0.008216068122543942,"768":-0.01812157400395922,"769":0.014326842578288477,"770":-0.007492891111344833,"771":-0.020275528380376245,"772":0.03223625667148611,"773":0.006947193033461365,"774":0.029964965351314217,"775":0.0004795325793056476,"776":0.017762708511941002,"777":-0.0012692617459193834,"778":-0.06571450178717352,"779":-0.07476045555244024,"780":0.171179164287675,"781":0.05473108689622413,"782":0.11722506492906559,"783":-0.05574204131623167,"784":-0.001062260586213644,"785":-0.017274972607427747,"786":0.09394791234804603,"787":0.09255598012513522,"788":-0.19368937073953918,"789":-0.041806504994917955,"790":-0.08845134202466916,"791":0.009704694779600823,"792":0.013080970668192176,"793":-0.02110228252816721,"794":0.07867710574083393,"795":0.07344082443178708,"796":-0.16582877574930036,"797":-0.03134380730358721,"798":-0.08955280693545932,"799":0.020776428746101056}},"b1":{"n":100,"d":1,"w":{"0":-0.006524366365970634,"1":-0.014055820980328306,"2":0.013182519808523007,"3":0.015942185851745373,"4":0.015247703727221893,"5":-0.022697994385455805,"6":0.010700228631308597,"7":0.016066304794206933,"8":-0.021107420538537904,"9":0.01770982748384901,"10":-0.026675143136264647,"11":-0.007737098530093731,"12":0.017335636608771583,"13":-0.03235391625310955,"14":-0.01599873324617432,"15":-0.028591459696110877,"16":0.05004325166201472,"17":0.018520138738560333,"18":-0.005432276647112035,"19":-0.010066908888293707,"20":0.01759990409197671,"21":0.00971802661062324,"22":-0.013666064861252575,"23":-0.03464284601601578,"24":-0.020997432174517258,"25":0.02743443584465229,"26":-0.03649086338651011,"27":-0.00837533651990388,"28":-0.0057547292334530625,"29":-0.01229618434693913,"30":0.0021959893578764487,"31":-0.012726040026548775,"32":0.02084463100576909,"33":0.023016033505248463,"34":-0.01457357972986349,"35":0.02394599999535387,"36":-0.01393870263835602,"37":0.022692696059171763,"38":-0.024765566183718054,"39":-0.012531317345095456,"40":0.0072643213503345554,"41":-0.019469528916796788,"42":-0.016807224254901193,"43":0.0019522982618499242,"44":-0.01658304680118308,"45":0.008430478393012522,"46":-0.017848201193312725,"47":0.006729894196348317,"48":0.018064653464291522,"49":-0.018376700949872673,"50":-0.02844553034017641,"51":-0.018908628746576586,"52":0.02100920035271233,"53":-0.015705782757895113,"54":-0.004134728414600168,"55":0.005890811046488872,"56":-0.016687373434322625,"57":0.013630825415640665,"58":-0.0070181641900723315,"59":0.01868921188831378,"60":-0.009812672328727168,"61":-0.022921146956213098,"62":0.02387484375440081,"63":-0.01413484729482373,"64":0.020726760121869137,"65":-0.004667542694972169,"66":-0.024106912092473242,"67":0.011994679601228577,"68":-0.0029873456247296406,"69":-0.0035798304332254377,"70":-0.020679613395327884,"71":0.019631293728532572,"72":-0.011424112610572868,"73":0.01762318340089242,"74":0.024987563068070633,"75":-0.021286050904232044,"76":0.030182452911575956,"77":0.008622146412953264,"78":0.009578484718589499,"79":-0.05125380601377738,"80":0.014738685814015991,"81":-1.48887004040356,"82":0.018223399272151865,"83":-0.02308580930470171,"84":0.09161544813620373,"85":0.016232171319716323,"86":-0.009613942934630455,"87":0.006706272748439368,"88":-0.0025261198548837123,"89":-0.009717827746831406,"90":-0.02018968318006908,"91":0.0037487791978264647,"92":-0.018835233587677115,"93":-0.01050240313006771,"94":-0.025218968672095218,"95":-0.009493273508598198,"96":0.004177293538767266,"97":0.03360903516007606,"98":-0.02565961388873171,"99":-0.022346522616000543}},"W2":{"n":5,"d":100,"w":{"0":-0.011055809226428306,"1":-0.10891250359373986,"2":0.01880021807926884,"3":0.02689681498761056,"4":0.10209049878606,"5":-0.10089497429458004,"6":0.0448509396602699,"7":0.0750722602911298,"8":-0.1094500266980941,"9":0.10841613559353706,"10":-0.121925266627169,"11":-0.0363313548503268,"12":0.08612282781291056,"13":-0.11739833933688483,"14":-0.061669041740560884,"15":-0.10831467314848021,"16":0.1330139632751313,"17":0.07043708529815004,"18":-0.010459866935372384,"19":-0.07834690306527285,"20":0.08131197349142293,"21":0.029624108894039356,"22":-0.07082657455943557,"23":-0.13576190629885304,"24":-0.07473703036255336,"25":0.12305121219010957,"26":-0.1273319031723146,"27":-0.11763021113211286,"28":0.0005274510819447667,"29":-0.018878930701837188,"30":-0.0012522492334558623,"31":-0.1388327134077064,"32":0.05901621526458581,"33":0.07746192819840422,"34":-0.03109647106837615,"35":0.10351024886272377,"36":-0.029708203145366426,"37":0.05395719080653869,"38":-0.11526041582304729,"39":-0.08357934697322277,"40":-0.005042431413713361,"41":-0.08275370869747171,"42":-0.047564873218329445,"43":-0.09385824445252884,"44":-0.08642196452927331,"45":0.059730258348882015,"46":-0.07986084014918142,"47":0.053409977146857704,"48":0.081103412289714,"49":-0.11061166407117926,"50":-0.07312596500870396,"51":-0.053588218239694306,"52":0.07083881522296402,"53":-0.04420294251952778,"54":-0.024138880018788514,"55":0.023318768299592382,"56":-0.1006035359630204,"57":0.07900203110836748,"58":-0.045746720182101006,"59":-0.14554256593815282,"60":-0.07513413829177273,"61":-0.09989939780889585,"62":0.1305437025421164,"63":-0.08118610093149138,"64":0.09821340834780022,"65":-0.018408187736760142,"66":-0.06831778509044263,"67":0.03992740914462536,"68":0.005549698470427675,"69":0.14119741395225455,"70":-0.12420437256441677,"71":0.10153948305291607,"72":-0.06680604752268347,"73":0.10929161940357697,"74":0.12162369788460478,"75":-0.0977192165616435,"76":0.12780514380797142,"77":0.028068249732892785,"78":0.006884582833567147,"79":-0.1428301802759207,"80":0.07461736676220279,"81":0.8806899683135756,"82":0.06406363915241055,"83":-0.03997008163525771,"84":-0.08708544497012059,"85":0.024311830792109336,"86":-0.03744665517361087,"87":0.03815556413631886,"88":-0.03234976906359998,"89":-0.015662834481171128,"90":-0.07599167697568902,"91":0.01544330691409035,"92":-0.08066244880420424,"93":-0.04006454905641079,"94":-0.0794799261994209,"95":0.005798951917817228,"96":0.020149017776063982,"97":0.12879145334571482,"98":-0.10475852496259104,"99":-0.09603128556854522,"100":-0.008851814136783577,"101":-0.1162564792104902,"102":0.034747316275151346,"103":0.03514741970339469,"104":0.09917754493362972,"105":-0.08612316254865958,"106":0.03612891586267766,"107":0.06722018088378429,"108":-0.1039156900524178,"109":0.11132705667825261,"110":-0.10776215125787252,"111":-0.05380012753981966,"112":0.0963308958593765,"113":-0.10640891217336865,"114":-0.05857218315719931,"115":-0.1271061322266712,"116":0.12217109819207511,"117":0.06894331195704233,"118":-0.011374974777856291,"119":-0.07321993958709304,"120":0.09023826251524514,"121":0.010165172677368696,"122":-0.06106430495141115,"123":-0.13109907512735974,"124":-0.0833483099705012,"125":0.11901871168624846,"126":-0.11242997676739543,"127":-0.12935253419189408,"128":-0.00381832109316588,"129":-0.01719508137675707,"130":-0.006703847311946438,"131":-0.1538781458491622,"132":0.05934190012985294,"133":0.07998819531026694,"134":-0.03668121308370973,"135":0.09029091495039583,"136":-0.03957405865952171,"137":0.03593389821509371,"138":-0.11222375515253995,"139":-0.07487919171325652,"140":-0.002824834350175827,"141":-0.08768338450395295,"142":-0.04738209384335892,"143":-0.10083439865435942,"144":-0.07300162579961655,"145":0.06397310812659139,"146":-0.06905744889746195,"147":0.0418581669637467,"148":0.09253741152049588,"149":-0.11058517056711378,"150":-0.08029181148520198,"151":-0.05496389173565282,"152":0.08114245049116464,"153":-0.03540243043138376,"154":-0.016166790884352425,"155":0.029464331317269284,"156":-0.0956246473338735,"157":0.06346361294385687,"158":-0.044615749685858394,"159":-0.17314122711986663,"160":-0.08197180898162769,"161":-0.08898588701844676,"162":0.13556702010640678,"163":-0.08408201855788627,"164":0.1100255429250401,"165":-0.019048153968127406,"166":-0.06146371584182947,"167":0.04025870781788658,"168":-0.0018853956472812405,"169":0.15486536898899778,"170":-0.13871437341445975,"171":0.1302226234239661,"172":-0.07173717512843794,"173":0.10810441993133937,"174":0.1318603201184819,"175":-0.07048916945806241,"176":0.11014821556427036,"177":0.023077935163771927,"178":0.022112180791170347,"179":-0.1748951131223187,"180":0.06132808402727577,"181":0.8821505858781233,"182":0.06770237264409086,"183":-0.033246635679893374,"184":-0.061634670598552696,"185":0.018414406456140116,"186":-0.018674123409453153,"187":0.042473354915312046,"188":-0.03585448572625469,"189":-0.011200636477984634,"190":-0.07409963895882908,"191":0.024196937902749432,"192":-0.09024669740077974,"193":-0.03613843618142661,"194":-0.0858794328984517,"195":-0.0037859075626899452,"196":0.018189116936942747,"197":0.12308144704038335,"198":-0.11874968812513188,"199":-0.10446784065107127,"200":-0.02751399365321725,"201":-0.10757783571703905,"202":0.025646396078931454,"203":0.058213704450952294,"204":0.09504427227622729,"205":-0.06335457203070004,"206":0.05780259468718185,"207":0.049071343342183424,"208":-0.0949761905029829,"209":0.1008933346880842,"210":-0.09720749225244506,"211":-0.06229824168661547,"212":0.12437716483771687,"213":-0.11016156067951263,"214":-0.05791055378049483,"215":-0.0980369717071146,"216":0.1648588549443687,"217":0.06024430931488413,"218":-0.026277667578513048,"219":-0.09203608173312361,"220":0.08298929554852456,"221":0.031102706356463353,"222":-0.0966179514056675,"223":-0.13029341372127062,"224":-0.08206068746684146,"225":0.10362978510871867,"226":-0.07489597529117642,"227":-0.12157743315231376,"228":0.0042803324387290665,"229":-0.05741184585198012,"230":0.018127290353842872,"231":-0.1002403415310477,"232":0.04715591536197471,"233":0.10694380379008202,"234":-0.031600786424872115,"235":0.06351267219869194,"236":0.0017264736635094994,"237":0.010061331400052545,"238":-0.10185838578059046,"239":-0.10844169330189812,"240":-0.016552532786897396,"241":-0.050829073485923346,"242":-0.08341533928298105,"243":-0.14127449523569655,"244":-0.08036438926890431,"245":0.08733688365445272,"246":-0.07433992863981462,"247":0.05524838719618039,"248":0.07691466727518258,"249":-0.1205353917357926,"250":-0.06092488589604128,"251":-0.05098471952839469,"252":0.08284379834579335,"253":-0.04879714517949248,"254":0.018945756715165758,"255":0.029940133915015377,"256":-0.08847203015100205,"257":0.03468624595761848,"258":-0.0024490679949434845,"259":-0.16829162051703703,"260":-0.08818648314104498,"261":-0.05780692563765877,"262":0.1289051548589479,"263":-0.09294028233066563,"264":0.1077063399611729,"265":-0.05253124261514431,"266":-0.061698500816436526,"267":0.0681564983273189,"268":-0.01373930684993896,"269":0.1380817516221308,"270":-0.11225937838479402,"271":0.15873517606821308,"272":-0.0005576299221924656,"273":0.08632617832615816,"274":0.1261866705829933,"275":-0.04437988388125215,"276":0.09238710967644094,"277":0.059239450794271745,"278":0.03237088530832863,"279":-0.18652363725223253,"280":0.04047301143467128,"281":0.6831968833922448,"282":0.09999610130822542,"283":-0.01198894658239207,"284":-0.10234751300419784,"285":0.06698013296622078,"286":-0.0427970808166816,"287":0.02088518252516424,"288":-0.04017440910447606,"289":0.011641390213919769,"290":-0.06294265084989574,"291":0.005190795931081675,"292":-0.10184370058537104,"293":-0.04675287106988218,"294":-0.056757511147366484,"295":-0.001698384010663478,"296":0.038652713586073015,"297":0.09453106790168829,"298":-0.12566714122340739,"299":-0.11860161074371944,"300":-0.051062711325040304,"301":-0.10309202739173264,"302":0.004629812058164412,"303":0.040856638574236125,"304":0.1008443885839086,"305":-0.05695064717913111,"306":0.06737706745996133,"307":0.023367766975809,"308":-0.0747515742328206,"309":0.10396813940415803,"310":-0.10051808586020758,"311":-0.06114645988534777,"312":0.09650794827250639,"313":-0.11766445648132409,"314":-0.054612279464363186,"315":-0.10942815008076906,"316":0.15732660017922095,"317":0.07239190058159735,"318":-0.014921312253346196,"319":-0.10263519767240323,"320":0.07845361598028835,"321":0.05392181685326847,"322":-0.09209764195737448,"323":-0.13283736082596725,"324":-0.08647239431493027,"325":0.09745022892351729,"326":-0.09099834731432162,"327":-0.1089260624125595,"328":-0.0058875470727641965,"329":-0.060807098461777655,"330":0.03747506507328371,"331":-0.10214588051232268,"332":0.04217805020886308,"333":0.07767349547335449,"334":-0.018672966825963273,"335":0.059986429674055916,"336":0.022079599366627567,"337":0.029334569238120306,"338":-0.10296197328674798,"339":-0.10229015028181819,"340":-0.01896010686354642,"341":-0.050894059997428936,"342":-0.07422703247825055,"343":-0.14632558801080117,"344":-0.08435907701162101,"345":0.0955895540949399,"346":-0.08014512880241052,"347":0.07080707811913832,"348":0.06124126299330922,"349":-0.10135119938004418,"350":-0.05812943392143378,"351":-0.032384089652455594,"352":0.08732473952062751,"353":-0.05384810650536397,"354":-0.0009748484916918639,"355":0.018344710855388958,"356":-0.07277045146790617,"357":0.055333545661745046,"358":-0.005957324229438516,"359":-0.16502705981623295,"360":-0.1037793517831229,"361":-0.0515838917814278,"362":0.13579989602577353,"363":-0.11046248330261156,"364":0.10587460833197805,"365":-0.055754770504367814,"366":-0.05112101817440659,"367":0.06811999448860158,"368":0.020851032172130357,"369":0.12049879735935035,"370":-0.11506024699354825,"371":0.13991281801537336,"372":-0.004338700961086796,"373":0.09766693049338973,"374":0.12977634195411727,"375":-0.05075104460341201,"376":0.08694345741422517,"377":0.04149651794826679,"378":0.011836393235846225,"379":-0.20240853140030107,"380":0.043720462701841795,"381":0.631618744234358,"382":0.09077317075495732,"383":0.008754623105477186,"384":-0.18597482302313928,"385":0.043896533630279774,"386":-0.035081331176180515,"387":0.007827185294687233,"388":-0.03888591946179784,"389":0.019509403704176583,"390":-0.07240064944955285,"391":0.0007554340454227596,"392":-0.09891342001650895,"393":-0.018138927771252162,"394":-0.03162854668133965,"395":-0.014609936052539609,"396":0.01356426325696508,"397":0.09739743983833116,"398":-0.1373296544764431,"399":-0.10210699373930829,"400":-0.019770129682022033,"401":-0.10817626258954156,"402":0.032050418150632504,"403":0.03160358488810795,"404":0.08797356500663243,"405":-0.09495825812595318,"406":0.022111155230468634,"407":0.06544796523999886,"408":-0.09880670462780514,"409":0.11051139027990738,"410":-0.10897016623672205,"411":-0.044189769524288616,"412":0.07722175900155218,"413":-0.12365562434015995,"414":-0.08018440298330771,"415":-0.12514355079969283,"416":0.14823762607286933,"417":0.07799561289742717,"418":-0.006412665411052048,"419":-0.07787140457839807,"420":0.08453770350799676,"421":0.02357394386720468,"422":-0.05806395179696634,"423":-0.13783296959740116,"424":-0.08247994952196397,"425":0.1183217379553114,"426":-0.11858634768649093,"427":-0.10204433225055376,"428":-0.013512173719310147,"429":-0.017274286443107835,"430":-0.0004096183690565038,"431":-0.14325993679423035,"432":0.06261128511681954,"433":0.07613973438595076,"434":-0.04208714799437915,"435":0.10112429354329665,"436":-0.03964440438833953,"437":0.05733391106455111,"438":-0.11072451828387166,"439":-0.07590902840940829,"440":-0.005798798181085487,"441":-0.08800139107680027,"442":-0.04791240527797771,"443":-0.0942614648146149,"444":-0.0697383065285082,"445":0.06338580339607613,"446":-0.07253083061829627,"447":0.04741215048454159,"448":0.08610939618172087,"449":-0.09758064540688517,"450":-0.0879985203171398,"451":-0.06415922250606898,"452":0.07993672741300763,"453":-0.04071599152055869,"454":-0.024079852247726356,"455":0.013597469340470649,"456":-0.10388495295718268,"457":0.07068355347286104,"458":-0.038454454645632366,"459":-0.1307157276708613,"460":-0.07044304370859396,"461":-0.08666012742398468,"462":0.12717242733852227,"463":-0.07740515363956126,"464":0.10358263343871385,"465":-0.02195126359741797,"466":-0.0659059958713055,"467":0.05300387559432579,"468":-0.0169649386897492,"469":0.12804598378816792,"470":-0.12307234349814082,"471":0.11115739468235758,"472":-0.06190147204166029,"473":0.10119176254173513,"474":0.1138936164615559,"475":-0.066557610993719,"476":0.12085891585267304,"477":0.03439244959619069,"478":0.02162653145193509,"479":-0.15279846102146877,"480":0.059561900497757794,"481":0.895308751413871,"482":0.05113262882498653,"483":-0.029033671378608995,"484":-0.08573412791240523,"485":0.01925120965992335,"486":-0.0174979435260971,"487":0.03588886386729553,"488":-0.026733663179353218,"489":-0.01022155834067125,"490":-0.08546177748048299,"491":0.021463040517779215,"492":-0.07128422399394733,"493":-0.03437366507380633,"494":-0.07818370519610376,"495":-0.00858763209395855,"496":0.009282281740184532,"497":0.14248851589645617,"498":-0.13148823227531034,"499":-0.10085835794033371}},"b2":{"n":5,"d":1,"w":{"0":-0.09936375907605804,"1":-0.09562061374073988,"2":-0.25323230005486214,"3":-0.27950761739201235,"4":-0.10508602127731727}}}}`;

const canvas = document.querySelector('canvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const width = canvas.width;
const height = canvas.height;

let thrust = 0;
let flameLength = 0;
let ticks = 1;
let score = 0;
let level = 1;
let gravity = 2;
let maxFuel = 200 + height / 7; // proportionate to screen height

console.log('Height', height);
console.log('Max Fuel', maxFuel);

function rand(min, max) {
  return Math.floor((max - min) * Math.random()) + min;
}

const avg = (a, b) => ((a + b) / 2) | 0;

function segment(data, start, end, rmin = 0, rmax = 2) {
  if (end - start <= 1) return;
  const min = data[start];
  const max = data[end];
  const val = avg(min, max) + rand(rmin, rmax);
  const mid = avg(start, end);
  data[mid] += val;
  segment(data, start, mid, rmin, rmax);
  segment(data, mid, end, rmin, rmax);
}

function buildHeightmap(size = 1, left = 0, right = 0, rmin, rmax) {
  const heightmap = Array(size).fill(0);
  heightmap[0] = left;
  heightmap[size - 1] = right;
  segment(heightmap, 0, heightmap.length - 1, rmin, rmax);
  return heightmap;
}

const landscape = buildHeightmap(32, 64, 64, -8, 16);

let lander = {
  x: 0,
  y: 50,
  w: 16,
  h: 16,
  vx: 5,
  vy: 0,
  rot: -Math.PI / 2, // 0
  fuel: maxFuel
};

const fps = 1000 / 30;
const timeDelta = 0.1;
const keys = {};
const UP = 38;
const LEFT = 37;
const RIGHT = 39;
const rotationDelta = 0.03;

let over = false;
let win = false;

const maxThrust = 10;
const mass = 1;

function getRandomLanding() {
  return width / 2;
  // return 40 + Math.random() * (width - 40);
}

function nextLevel() {
  maxFuel *= 0.95;
  gravity += 0.2;
  lander = {
    x: 0,
    y: 50,
    w: 16,
    h: 16,
    vx: 5,
    vy: 0,
    rot: -Math.PI / 2,
    fuel: maxFuel
  };
  ticks = 1;
  over = false;
  landing = getRandomLanding();
  level++;
}

let landing = getRandomLanding();
let platformWidth = 50;
let platformHeight = 10;

function reset() {
  lander = {
    x: 0,
    y: 50,
    w: 16,
    h: 16,
    vx: 5,
    vy: 0,
    rot: -Math.PI / 2, // 0
    fuel: maxFuel
  };
  over = false;
  win = false;
  landing = getRandomLanding();
  thrust = 0;
  flameLength = 0;
  ticks = 1;
  score = 0;
}

function text(str, x, y, s = 10) {
  ctx.font = s + 'px serif';
  ctx.fillText(str, x, y);
}

const stars = Array(512 * 2)
  .fill(0)
  .map(() => Math.max(width, height) * Math.random());

function isLevel() {
  return Math.abs(lander.rot) < angleLimit;
}

function getVelocityDeltaAt(time, thrustOmega = 1) {
  const forceX = Math.sin(lander.rot) * thrust * thrustOmega;
  const forceY = Math.cos(lander.rot) * thrust * thrustOmega;

  const accX = forceX / mass;
  const accY = -forceY / mass + gravity;

  const t = time ** 2 / 2;

  return {
    vx: accX * t,
    vy: accY * t
  };
}

function getPositionAt() {}

function render() {
  ctx.fillStyle = 'black';
  ctx.fillRect(0, 0, width, height);

  ctx.fillStyle = 'white';

  for (let i = 0; i < stars.length; i += 2) {
    ctx.fillRect(stars[i], stars[i + 1], 1, 1);
  }

  text(
    `Alt: ${(height - platformHeight - lander.y - lander.h / 2) | 0}`,
    width - 50,
    20,
    10
  );
  text(`Horz: ${(lander.vx * 100) | 0}`, width - 50, 30, 10);
  text(`Vert: ${(lander.vy * 100) | 0}`, width - 50, 40, 10);
  text(`Spin: ${lander.rot}`, width - 50, 50, 10);
  text(`Difficulty: ${level}`, width - 50, 60, 10);

  if (over) {
    text(win ? `Win!` : 'Fail', width / 2, height / 2, 50);
  }

  text(getState().join(','), width / 2, 100, 30);
  text(getScore() + '', width / 2, 150, 30);

  // Draw landscape
  ctx.strokeStyle = 'white';
  ctx.fillStyle = 'black';
  ctx.beginPath();
  const spacing = width / landscape.length;
  ctx.moveTo(0, height - landscape[0]);
  for (let i = 1; i < landscape.length; i++) {
    ctx.lineTo(spacing * i, height - landscape[i]);
  }
  ctx.lineTo(width, height);
  ctx.lineTo(0, height);
  ctx.fill();
  ctx.stroke();

  // Draw fuel
  ctx.strokeStyle = 'white';
  ctx.fillStyle = 'white';
  ctx.beginPath();
  const u = height - 20;
  ctx.rect(10, 10, 20, u);
  const e = u * (lander.fuel / maxFuel);
  ctx.fillRect(10, 10 + u - e, 20, e);
  ctx.stroke();

  // Draw ship
  ctx.save();

  ctx.translate(lander.x, lander.y);
  ctx.rotate(lander.rot);
  ctx.translate(-lander.x, -lander.y);

  ctx.strokeStyle = isLevel() ? 'green' : 'white';
  ctx.beginPath();
  ctx.rect(lander.x - lander.w / 2, lander.y - lander.h, lander.w, lander.h);
  ctx.moveTo(lander.x - lander.w / 2, lander.y);
  ctx.lineTo(lander.x - lander.w / 2 - 4, lander.y + 8);
  ctx.moveTo(lander.x + lander.w / 2, lander.y);
  ctx.lineTo(lander.x + lander.w / 2 + 4, lander.y + 8);
  ctx.stroke();
  if (thrust > 0) {
    ctx.beginPath();
    ctx.moveTo(lander.x - 4, lander.y);
    ctx.lineTo(lander.x, lander.y + flameLength);
    ctx.lineTo(lander.x + 4, lander.y);
    ctx.fill();
  }

  ctx.restore();

  if (level === 1) {
    // Draw projection
    let x = lander.x;
    let y = lander.y;
    let vx = lander.vx;
    let vy = lander.vy;
    for (let frame = 0; frame < 500; frame++) {
      const delta = getVelocityDeltaAt(timeDelta, 0.01);
      vx += delta.vx;
      vy += delta.vy;
      x += vx;
      y += vy;
      if (frame % 7 === 0) {
        ctx.fillStyle = 'red';
        ctx.fillRect(x, y, 2, 2);
      }
    }
  }

  ctx.fillStyle = 'white';
  ctx.fillRect(
    landing - platformWidth / 2,
    height - platformHeight,
    platformWidth,
    platformHeight
  );
}

const velLimit = 0.5;
const angleLimit = 0.11;
const distLimit = 13;

function isSlowApproach() {
  const vel = lander.vy + lander.vx;
  return vel < velLimit;
}

const LOWER = 2;

function getScore() {
  const phase = phaseOfLanding();
  const left = isLeftOfPlatform();
  const right = isRightOfPlatform();
  const over = !left && !right;
  const parts = [
    phase === LOWER ? (isSlowApproach() ? 1 : -1) : 0,
    phase === LOWER ? (isLevel() ? 1 : -1) : 0,
    over ? 2 : -2,
    phase - 1
  ];
  return parts.reduce((score, n) => score + n, 0) * 0.1;
}

function update() {
  if (over) return;

  if (lander.x < 0 || lander.x > canvas.width || lander.y < 0) {
    over = true;
    win = false;
  }

  const landed = lander.y + lander.h / 2 >= height - platformHeight;
  if (landed) {
    over = true;

    // console.log('vel:', lander.vx + lander.vy);
    // console.log('rot:', lander.rot);
    // console.log('land:', Math.abs(lander.x - landing));

    const dist = Math.abs(lander.x - landing);

    const onPlatform = dist < distLimit;

    win = isSlowApproach() && isLevel() && onPlatform;
    // const s = vel / velLimit + angle / angleLimit + dist / distLimit;
    // score = Math.round(s * -33.33 + 100) + lander.fuel;

    if (win) {
      nextLevel();
    }
  }

  if (keys[UP] && lander.fuel > 0) {
    thrust = maxThrust;
    flameLength = Math.min(flameLength + 1, 10 + (ticks % 5));
    lander.fuel--;
  } else {
    flameLength = 0;
    thrust = 0;
  }

  const { vx, vy } = getVelocityDeltaAt(timeDelta);

  lander.vx += vx;
  lander.vy += vy;

  lander.x += lander.vx;
  lander.y += lander.vy;

  if (keys[LEFT]) lander.rot -= rotationDelta;
  if (keys[RIGHT]) lander.rot += rotationDelta;
}

document.addEventListener('keydown', e => (keys[e.which] = true));
document.addEventListener('keyup', e => (keys[e.which] = false));

// Actions for AI

function engageThruster() {
  keys[UP] = true;
}

function disengageThruster() {
  keys[UP] = false;
}

function rotateLeft() {
  keys[LEFT] = true;
  keys[RIGHT] = false;
}

function rotateRight() {
  keys[RIGHT] = true;
  keys[LEFT] = false;
}

function doNothing() {
  keys[RIGHT] = false;
  keys[UP] = false;
  keys[LEFT] = false;
}

const actions = {
  0: engageThruster,
  1: disengageThruster,
  2: rotateLeft,
  3: rotateRight,
  4: doNothing
};

function isLeftOfPlatform() {
  return lander.x < landing - platformWidth / 2;
}

function isRightOfPlatform() {
  return lander.x > landing + platformWidth / 2;
}

function phaseOfLanding() {
  return Math.floor((lander.y / height) * 3);
}

function getState() {
  return [
    isLevel() ? 1 : 0,
    isSlowApproach() ? 1 : 0,
    isLeftOfPlatform() ? 1 : 0,
    isRightOfPlatform() ? 1 : 0,
    !isRightOfPlatform() && !isLeftOfPlatform() ? 1 : 0,
    phaseOfLanding() === 0 ? 1 : 0,
    phaseOfLanding() === 1 ? 1 : 0,
    phaseOfLanding() === 2 ? 1 : 0
  ];
}

const stateCount = getState().length;

// create an environment object
const env = {};
env.getNumStates = function() {
  return stateCount;
};
env.getMaxNumActions = function() {
  return 5;
};

const agent = new RL.DQNAgent(env);

agent.fromJSON(JSON.parse(data));

let prevScore = 0;

function getReward() {
  const reward = getScore();
  prevScore = score;
  return reward;
}

let rewardSum = 0;
let rewardCount = 0;

function train() {
  actions[agent.act(getState())]();
  const reward = getReward();
  rewardSum += reward;
  rewardCount++;
  agent.learn(reward);
}

function gameLoop() {
  update(ticks);

  if (over) {
    console.log('Average Reward', rewardSum / rewardCount);
    rewardSum = 0;
    rewardCount = 0;
    reset();
  }

  render(ticks);
  requestAnimationFrame(gameLoop);
  ticks++;
}

gameLoop();

setInterval(train, 0);
